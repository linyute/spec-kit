--- 
description: 透過提出最多 5 個高度針對性的澄清問題，並將答案編碼回規格中，識別當前功能規格中未明確的領域。
handoffs: 
  - label: Build Technical Plan
    agent: speckit.plan
    prompt: Create a plan for the spec. I am building with...
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## 使用者輸入

```text
$ARGUMENTS
```

您**必須**在繼續之前考慮使用者輸入（如果非空）。

## 概述

目標：偵測並減少活動功能規格中的模糊或缺失決策點，並將澄清直接記錄在規格檔案中。

注意：此澄清工作流程預計在調用 `/speckit.plan` 之前執行（並完成）。如果使用者明確表示他們跳過澄清（例如，探索性試驗），您可以繼續，但必須警告下游返工風險會增加。

執行步驟：

1. 從倉庫根目錄**一次**執行 `{SCRIPT}`（組合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最少的 JSON 負載欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選地捕獲 `IMPL_PLAN`、`TASKS` 以用於未來的鏈式流程。）
   - 如果 JSON 解析失敗，則中止並指示使用者重新執行 `/speckit.specify` 或驗證功能分支環境。
   - 對於像 "I'm Groot" 這樣的參數中的單引號，請使用轉義語法：例如 'I'\''m Groot'（如果可能，也可以使用雙引號："I'm Groot"）。

2. 載入當前規格檔案。使用此分類法執行結構化的模糊和覆蓋率掃描。對於每個類別，標記狀態：清晰 / 部分 / 缺失。產生用於優先級排序的內部覆蓋率映射（除非不提出問題，否則不輸出原始映射）。

   功能範圍和行為：
   - 核心使用者目標和成功標準
   - 明確的範圍外聲明
   - 使用者角色 / 人物區分

   領域和資料模型：
   - 實體、屬性、關係
   - 身份和唯一性規則
   - 生命週期/狀態轉換
   - 資料量 / 規模假設

   互動和使用者體驗流程：
   - 關鍵使用者旅程 / 序列
   - 錯誤/空/載入狀態
   - 可訪問性或本地化備註

   非功能品質屬性：
   - 效能（延遲、吞吐量目標）
   - 延展性（水平/垂直、限制）
   - 可靠性和可用性（正常運行時間、恢復預期）
   - 可觀察性（日誌記錄、指標、追蹤訊號）
   - 安全和隱私（身份驗證/授權、資料保護、威脅假設）
   - 合規性 / 法規約束（如果有的話）

   整合和外部依賴：
   - 外部服務/API 和故障模式
   - 資料匯入/匯出格式
   - 協定/版本控制假設

   邊緣案例和故障處理：
   - 負面情境
   - 速率限制 / 節流
   - 衝突解決（例如，並發編輯）

   約束和權衡：
   - 技術約束（語言、儲存、託管）
   - 明確的權衡或拒絕的替代方案

   術語和一致性：
   - 規範詞彙術語
   - 避免的同義詞 / 已棄用的術語

   完成訊號：
   - 接受標準可測試性
   - 可衡量的完成定義樣式指標

   雜項 / 佔位符：
   - TODO 標記 / 未解決的決策
   - 模糊形容詞（「穩健」、「直觀」）缺乏量化

   對於每個狀態為部分或缺失的類別，添加一個候選問題機會，除非：
   - 澄清不會實質性改變實作或驗證策略
   - 資訊最好推遲到規劃階段（內部註明）

3. （內部）產生一個優先級排序的候選澄清問題佇列（最多 5 個）。不要一次全部輸出。應用這些約束：
    - 整個會話中最多 10 個問題。
    - 每個問題必須可以透過以下方式回答：
       - 簡短的多項選擇（2-5 個不同、互斥的選項），或
       - 一個詞 / 短語答案（明確限制：「答案在 <=5 個詞內」）。
    - 僅包含其答案實質性影響架構、資料建模、任務分解、測試設計、使用者體驗行為、操作準備或合規性驗證的問題。
    - 確保類別覆蓋率平衡：嘗試首先覆蓋影響最大的未解決類別；避免在單個高影響區域（例如，安全態勢）未解決時提出兩個低影響問題。
    - 排除已回答的問題、瑣碎的樣式偏好或計畫級別的執行細節（除非阻礙正確性）。
    - 優先考慮減少下游返工風險或防止不一致的接受測試的澄清。
    - 如果超過 5 個類別仍未解決，則根據（影響 * 不確定性）啟發式選擇前 5 個。

4. 順序提問循環（互動式）：
    - 一次呈現**恰好一個**問題。
    - 對於多項選擇問題：
       - **分析所有選項**並根據以下因素確定**最合適的選項**：
          - 專案類型的最佳實踐
          - 類似實作中的常見模式
          - 風險降低（安全、效能、可維護性）
          - 與規格中可見的任何明確專案目標或約束保持一致
       - 在頂部突出顯示您的**推薦選項**，並附上清晰的理由（1-2 句話解釋為什麼這是最佳選擇）。
       - 格式為：`**推薦：** 選項 [X] - <理由>`
       - 然後將所有選項渲染為 Markdown 表格：

       | 選項 | 描述 |
       |--------|-------------|
       | A | <選項 A 描述> |
       | B | <選項 B 描述> |
       | C | <選項 C 描述> (根據需要添加 D/E，最多 5 個) |
       | 簡短 | 提供不同的簡短答案 (<=5 個詞) (僅在自由形式替代方案適用時包含) |

       - 在表格之後，添加：`您可以回覆選項字母（例如，「A」），透過說「是」或「推薦」來接受推薦，或提供您自己的簡短答案。`
    - 對於簡短答案樣式（沒有有意義的離散選項）：
       - 根據最佳實踐和上下文提供您的**建議答案**。
       - 格式為：`**建議：** <您建議的答案> - <簡要理由>`
       - 然後輸出：`格式：簡短答案 (<=5 個詞)。您可以透過說「是」或「建議」來接受建議，或提供您自己的答案。`
    - 使用者回答後：
       - 如果使用者回覆「是」、「推薦」或「建議」，則使用您先前陳述的推薦/建議作為答案。
       - 否則，驗證答案是否映射到一個選項或符合 <=5 個詞的約束。
       - 如果模糊，請要求快速消除歧義（計數仍屬於同一問題；不要推進）。
       - 一旦滿意，將其記錄在工作記憶中（尚未寫入磁碟）並轉到下一個排隊的問題。
    - 在以下情況下停止提出更多問題：
       - 所有關鍵歧義都已及早解決（剩餘的排隊項目變得不必要），或
       - 使用者發出完成訊號（「完成」、「好」、「沒有更多」），或
       - 您達到 5 個已提出的問題。
    - 永遠不要提前透露未來排隊的問題。
    - 如果開始時沒有有效問題，則立即報告沒有值得正式澄清的關鍵歧義。

5. 每個接受的答案後整合（增量更新方法）：
    - 維護規格的記憶體中表示（啟動時載入一次）以及原始檔案內容。
    - 對於本次會話中的第一個整合答案：
       - 確保存在 `## 澄清` 部分（如果缺失，則在規格範本中最高級別的上下文/概述部分之後建立）。
       - 在其下方，建立（如果不存在）一個 `### 會話 YYYY-MM-DD` 副標題，用於今天。
    - 接受後立即附加一個項目符號行：`- 問：<問題> → 答：<最終答案>`。
    - 然後立即將澄清應用於最合適的部分：
       - 功能模糊 → 在功能需求中更新或添加項目符號。
       - 使用者互動 / 參與者區分 → 使用澄清的角色、約束或情境更新使用者故事或參與者子部分（如果存在）。
       - 資料形狀 / 實體 → 更新資料模型（添加欄位、類型、關係），保留順序；簡潔地註明添加的約束。
       - 非功能約束 → 在非功能 / 品質屬性部分中添加/修改可衡量標準（將模糊形容詞轉換為指標或明確目標）。
       - 邊緣案例 / 負面流程 → 在邊緣案例 / 錯誤處理下添加新項目符號（或如果範本提供佔位符，則建立此類子部分）。
       - 術語衝突 → 規範化整個規格中的術語；僅在必要時透過添加 `（以前稱為「X」）` 一次來保留原始術語。
    - 如果澄清使先前的模糊陳述失效，則替換該陳述而不是重複；不要留下過時的矛盾文字。
    - 每次整合後儲存規格檔案，以最大程度地減少上下文丟失的風險（原子覆蓋）。
    - 保留格式：不要重新排序不相關的部分；保持標題層次結構完整。
    - 保持每個插入的澄清最小化且可測試（避免敘述性漂移）。

6. 驗證（每次寫入後以及最終通過後執行）：
    - 澄清會話中每個接受的答案恰好包含一個項目符號（無重複）。
    - 提出的（接受的）問題總數 <= 5。
    - 更新的部分不包含新答案旨在解決的任何殘留的模糊佔位符。
    - 沒有矛盾的早期陳述保留（掃描已刪除的現在無效的替代選擇）。
    - Markdown 結構有效；僅允許新標題：`## 澄清`、`### 會話 YYYY-MM-DD`。
    - 術語一致性：所有更新的部分都使用相同的規範術語。

7. 將更新後的規格寫回 `FEATURE_SPEC`。

8. 報告完成情況（在提問循環結束或提前終止後）：
    - 提出和回答的問題數量。
    - 更新規格的路徑。
    - 觸及的部分（列出名稱）。
    - 覆蓋率摘要表，列出每個分類類別及其狀態：已解決（部分/缺失並已解決）、推遲（超出問題配額或更適合規劃）、清晰（已足夠）、未解決（仍部分/缺失但影響較小）。
    - 如果仍有任何未解決或推遲的項目，建議是繼續執行 `/speckit.plan` 還是稍後在計畫後再次執行 `/speckit.clarify`。
    - 建議的下一個命令。

行為規則：

- 如果沒有發現有意義的模糊之處（或所有潛在問題的影響都很小），則回應：「未偵測到值得正式澄清的關鍵模糊之處。」並建議繼續。
- 如果規格檔案缺失，則指示使用者先執行 `/speckit.specify`（不要在此處建立新規格）。
- 提出的問題總數永遠不要超過 5 個（單個問題的澄清重試不計為新問題）。
- 避免推測性技術堆疊問題，除非缺失阻礙了功能清晰度。
- 尊重使用者提前終止訊號（「停止」、「完成」、「繼續」）。
- 如果由於完全覆蓋而未提出問題，則輸出簡潔的覆蓋率摘要（所有類別均清晰），然後建議推進。
- 如果配額已滿，但仍有未解決的高影響類別，則明確將其標記為推遲，並說明理由。

優先級上下文：{ARGS}
